version: v1.0
name: Build and Test
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Build App
    task:
      jobs:
        - name: Build App
          commands:
            - checkout
            - docker build -t your-image .
    dependencies:
      - Run Test
  - name: Build Test
    dependencies: []
    task:
      jobs:
        - name: Build Test
          commands:
            - checkout
            - docker build . -f testDockerfile -t jakejack13/counter-test
        - name: ''
          commands: []
  - name: Run Test
    dependencies:
      - Build Test
    task:
      jobs:
        - name: Run Test
          commands:
            - docker run jakejack13/counter-test
  - name: Run App
    dependencies:
      - Build App
    task:
      jobs:
        - name: Run App
          commands:
            - 'docker run -d -p 8080:8080 jakejack13/counter-test'
            - 'curl localhost:8080/hello'
promotions:
  - name: Push App Image
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: branch = 'main' AND result = 'passed'
  - name: Push Test Image
    pipeline_file: pipeline_3.yml
    auto_promote:
      when: branch = 'main' AND result = 'passed'
